# Ralph Progress Log

Started: 2026-01-28
Project: PDF-Extraction (Hybrid Architecture)
Branch: ralph/hybrid-extraction-pipeline

---

## Codebase Patterns

- **Gemini SDK:** Use `from google import genai` (modern SDK), NOT `google.generativeai`
- **Settings Pattern:** Use `get_settings()` for configuration access (singleton via @lru_cache)
- **Testing Settings:** Always call `get_settings.cache_clear()` before testing environment variables
- **Pydantic v2:** Raises `ValidationError` for validation failures (not `ValueError`)
- **Mypy Configuration:** Requires `plugins = pydantic.mypy` in mypy.ini for BaseSettings support

---

## 2026-01-28 03:30 - US-001
- Implemented Python project structure and configuration
- Created directory structure: app/, app/routers/, app/services/, app/models/, app/db/, tests/
- Created .gitignore with Python, venv, and project-specific exclusions
- Created .env.example with API key placeholders
- Created __init__.py files in all Python packages
- Created comprehensive README.md with setup instructions and architecture overview

**Files changed:**
- Created: .gitignore, .env.example, README.md
- Created: app/__init__.py, app/routers/__init__.py, app/services/__init__.py, app/models/__init__.py, app/db/__init__.py, tests/__init__.py

**Learnings for future iterations:**
- Project follows standard Python package structure with clear separation of concerns
- All configuration should go through environment variables (.env file)
- Empty __init__.py files are needed to make directories valid Python packages
- .gitignore must include .env to prevent accidental secret commits

---

## 2026-01-28 04:00 - US-002
- Implemented requirements.txt with all project dependencies
- Added core dependencies: opendataloader-pdf (>=1.0.0), google-genai (>=0.3.0 - modern SDK)
- Added FastAPI ecosystem: fastapi (>=0.100.0), uvicorn (>=0.23.0)
- Added database client: supabase-py (>=2.0.0)
- Added data validation: pydantic (>=2.0.0), pydantic-settings (>=2.0.0)
- Added file handling utilities: python-multipart, python-dotenv, python-magic, httpx
- Added testing framework: pytest, pytest-asyncio, pytest-cov
- Installation already documented in README.md

**Files changed:**
- Created: requirements.txt
- Updated: scripts/ralph/prd.json (marked US-002 as passes: true)

**Learnings for future iterations:**
- Use google-genai (modern SDK) NOT google-generativeai (legacy)
- All dependencies have minimum version constraints (>=) for compatibility
- Test dependencies are included in requirements.txt for CI/CD setup
- README.md already contained installation instructions from US-001

---

## 2026-01-28 05:00 - US-003
- Implemented centralized configuration with Pydantic Settings
- Created app/config.py with Settings class extending pydantic_settings.BaseSettings
- Added configuration fields: gemini_api_key, supabase_url, supabase_key, model_name (default: gemini-3-flash-preview), enable_hybrid_mode (default: True)
- Implemented field validators for GEMINI_API_KEY, SUPABASE_URL, and SUPABASE_KEY with detailed error messages
- Created get_settings() function with @lru_cache for singleton pattern
- Fixed requirements.txt: corrected package name from supabase-py to supabase
- Created comprehensive test suite in tests/test_config.py with 13 tests covering:
  - Valid configuration loading
  - Custom configuration values
  - Missing/empty/whitespace-only API keys validation
  - Invalid Supabase URL validation (must be HTTPS)
  - Settings caching behavior
- All tests pass, typecheck passes with mypy

**Files changed:**
- Created: app/config.py, tests/test_config.py
- Updated: requirements.txt (supabase-py â†’ supabase)
- Updated: scripts/ralph/prd.json (marked US-003 as passes: true)

**Learnings for future iterations:**
- Use pydantic_settings.BaseSettings for environment variable loading (not pydantic.BaseSettings)
- Field validators should use @field_validator decorator with @classmethod
- Settings.model_config uses SettingsConfigDict (not nested Config class in Pydantic v2)
- Always validate credentials at startup to fail fast with clear error messages
- The Supabase Python package is named 'supabase' not 'supabase-py'
- Use @lru_cache on settings getter to ensure singleton pattern across the app
- Validators should strip whitespace from user inputs for better UX

---

## 2026-01-28 06:00 - US-004
- Implemented Gemini API client initialization with error handling
- Created app/services/gemini_client.py with get_gemini_client() function
- Uses modern google-genai SDK (from google import genai)
- Returns genai.Client initialized with API key from settings
- Clear error messages for missing GEMINI_API_KEY
- Created mypy.ini configuration file with Pydantic plugin support
- Created comprehensive test suite in tests/test_gemini_client.py
- All 5 tests pass covering:
  - Successful client initialization with valid API key
  - Missing API key raises ValidationError (Pydantic v2)
  - Empty API key raises ValidationError
  - Whitespace-only API key raises ValidationError
  - Client instance is returned correctly
- Typecheck passes with mypy

**Files changed:**
- Created: app/services/gemini_client.py, tests/test_gemini_client.py, mypy.ini
- Updated: scripts/ralph/prd.json (marked US-004 as passes: true)

**Learnings for future iterations:**
- Use 'from google import genai' NOT 'google.generativeai' (modern SDK)
- Pydantic v2 raises ValidationError (not ValueError) for missing required fields
- MagicMock(spec=SomeClass) fails if SomeClass is already mocked - just use MagicMock() without spec
- Need mypy.ini with 'plugins = pydantic.mypy' to handle BaseSettings() calls correctly
- Settings validation happens automatically when get_settings() is called, before reaching get_gemini_client()
- Tests should clear get_settings.cache_clear() to force re-validation when testing environment variables

---

## 2026-01-28 07:00 - US-005
- Implemented Pydantic models for PDF extraction results
- Created app/models/extraction.py with 7 model classes:
  - BoundingBox: PDF coordinates (x1, y1, x2, y2, page) with page >= 1 validation
  - ExtractedMetadata: Bibliographic info with year range validation (1900-2100)
  - ExtractedSection: Document sections with heading, content, page, optional bbox
  - ExtractedTable: Tables with caption, data (List[dict]), page, optional bbox
  - ExtractedReference: Parsed references with citation text, authors, year, title
  - DocumentStructure: OpenDataLoader output (markdown, tables, bboxes, quality_score 0-1, element_count)
  - ExtractionResult: Final pipeline output with metadata, abstract, sections, tables, references, confidence_score 0-1, bounding_boxes dict, processing_metadata dict
- Created comprehensive test suite: tests/test_extraction_models.py with 20 tests
- All tests cover validation, defaults, field constraints, and edge cases
- Tests pass (20/20), typecheck passes with --strict mode

**Files changed:**
- Created: app/models/extraction.py, tests/test_extraction_models.py
- Updated: scripts/ralph/prd.json (marked US-005 as passes: true)

**Learnings for future iterations:**
- Pydantic Field() allows ge/le constraints for numeric validation (e.g., confidence_score between 0-1)
- default_factory=list/dict prevents mutable default arguments bug
- Optional[T] with default=None is correct pattern for nullable fields
- BaseModel with Field(description=...) provides self-documenting schemas
- Use Dict[str, BoundingBox] not dict[str, BoundingBox] for Python 3.8 compatibility (though typing.Dict is preferred)
- Field validators automatically run on model instantiation - no need for custom __init__

---

## 2026-01-28 08:00 - US-006
- Implemented OpenDataLoader PDF structure extraction
- Created app/services/opendataloader_extractor.py with extract_pdf_structure() function
- Uses opendataloader_pdf.convert() to generate JSON and Markdown output files
- Extracts markdown representation, tables with bounding boxes, and element bounding boxes
- Returns DocumentStructure model with quality_score placeholder (calculated in US-007)
- Created comprehensive test suite: tests/test_opendataloader_extractor.py with 11 tests
- All tests pass (11/11)

**Files changed:**
- Created: app/services/opendataloader_extractor.py, tests/test_opendataloader_extractor.py
- Updated: scripts/ralph/prd.json (marked US-006 as passes: true)

**Learnings for future iterations:**
- OpenDataLoader API uses functional `convert()` not object-oriented `DocumentLoader()` class
- The convert() function writes JSON/Markdown files to disk - must read them to extract data
- JSON structure has "elements" array with type, page, text, bbox, and optional table_data fields
- Pydantic models auto-convert dict inputs to typed objects (e.g., Dict[str, BoundingBox])
- When testing Pydantic models, access BoundingBox attributes (bbox.x1) not dict keys (bbox["x1"])
- Use tempfile.TemporaryDirectory() context manager to clean up output files automatically
- OpenDataLoader requires quiet=True parameter to suppress console output during conversion
---

## 2026-01-28 09:00 - US-007
- Implemented quality scoring for routing decisions in hybrid extraction pipeline
- Created calculate_quality_score() function with weighted scoring criteria:
  - Text completeness (40%): >1000 chars = 0.4, >500 = 0.3, >100 = 0.2
  - Structure detection (30%): >50 elements = 0.3, >20 = 0.2, >5 = 0.1
  - Heading hierarchy (15%): >=5 headings = 0.15, >=3 = 0.1, >=1 = 0.05
  - Table extraction (15%): valid tables (>3 rows) = 0.15, some tables = 0.1
- Updated extract_pdf_structure() to calculate and include quality_score in result
- Score is capped at 1.0 using min(score, 1.0)
- Created comprehensive test suite with 16 new tests covering:
  - All scoring thresholds and boundary conditions
  - Realistic high-quality and low-quality PDF scenarios
  - Edge cases (empty documents, mixed table quality)
  - Floating-point precision handling
- All 27 tests pass, typecheck passes with mypy --strict

**Files changed:**
- Updated: app/services/opendataloader_extractor.py (added calculate_quality_score function)
- Updated: tests/test_opendataloader_extractor.py (added 16 quality scoring tests)
- Updated: scripts/ralph/prd.json (marked US-007 as passes: true)

**Learnings for future iterations:**
- Quality score determines routing: <0.7 triggers Vision fallback, >=0.7 uses hybrid mode
- Valid tables are defined as having >3 rows to filter out single-row artifacts
- Floating-point arithmetic requires approximate comparisons in tests (use abs(a - b) < 0.001)
- Quality scoring is now integrated into extract_pdf_structure() - no separate call needed
- The quality_score field in DocumentStructure is no longer a placeholder
---

